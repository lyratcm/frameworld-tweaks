namespace = fwt

country_event = {
    id = fwt.1
    hide_window = yes
    is_triggered_only = yes

    trigger = { giga_has_frameworld_origin = yes }
    immediate = {
        #backup as can't seem to trigger the event via an onaction
        random_planet_within_border = {
            limit = {
                exists = owner
                owner = { giga_has_frameworld_origin = yes }
                giga_is_frame_world = yes
            }
            fwt_clear_district = { district = district_generator }
            fwt_clear_district = { district = district_mining }
            fwt_clear_district = { district = district_farming }
            fwt_clear_district = { district = district_city }
            fwt_clear_district = { district = district_hive }
            fwt_clear_district = { district = district_nexus }
            save_global_event_target_as = frame_expand@owner
            owner = {
                set_variable = {
                    which = fwt_expansion_income
                    value = 70
                }
                set_country_flag = fwt_maintenance_default
                set_variable = {
                    which = fwt_decision_time
                    value = 360
                }
                if = {
                    limit = { megacorp_metamod_enable = yes }
                    set_variable = {
                        which = fwt_growth_ceiling
                        value = 5
                    }
                    set_variable = {
                        which = fwt_required_scaling
                        value = 0.25
                    }
                }
                else = {
                    set_variable = {
                        which = fwt_growth_ceiling
                        value = 5
                    }
                    set_variable = {
                        which = fwt_required_scaling
                        value = 0.25
                    }
                }
            }
            #used in some places for mult if gigas needed it
            set_variable = { which = fwt_energy_completion value = 1 }
            set_variable = { which = fwt_mineral_completion value = 1 }
            set_variable = { which = fwt_food_completion value = 1 }
            set_variable = { which = fwt_alloy_completion value = 1 }
            set_variable = { which = fwt_consumer_goods_completion value = 1 }
            set_variable = { which = fwt_unity_trade_completion value = 1 }
            set_variable = { which = fwt_sanctuary_completion value = 1 }
            set_variable = { which = fwt_science_completion value = 1 }
            set_variable = { which = fwt_rare_resources_completion value = 1 }
            set_variable = { which = fwt_city_completion value = 1 }
            # code for my job scaling
            set_variable = { which = frame_expansion_scale value = 1 }
            # set_variable = { which = background_pops value = 0 }
            set_variable = { which = fwt_maintance_scale value = 0.5 }
            add_modifier = {
                modifier = fwt_speed_unemploy_info
                multiplier = -100000000
                days = 40
            }
            set_variable = {
                which = fwt_maintenance_count
                value = 1
            }
        }
        # country_event = { id = giga_frameworld_origin.000 }
    }
    after = {
        # clear the conquered modifier which apparently gets executed BEFORE the start event
        remove_modifier = frameworld_conquered
        country_event = {
            id = fwt.12

        }
        country_event = {
            id = fwt.11
            days = 1
        }
        event_target:frame_expand@owner = {
            planet_event = {
                id = fwt.111
                days = 5
            }
        }
    }
}


country_event = {
    id = fwt.11
    hide_window = yes
    is_triggered_only = yes

    trigger = { giga_has_frameworld_origin = yes }

    immediate = {
        #backup in case it breaks, if your capital isn't the frameworld something is wrong but don't want to break it further
        if = {
            limit = { capital_scope = { giga_is_frame_world = yes } }
            capital_scope = { save_global_event_target_as = frame_expand@owner }
        }
    }
}

planet_event = {
    id = fwt.111
    hide_window = yes
    is_triggered_only = yes

    trigger = { giga_is_frame_world = yes }

    immediate = {
        #setup frameworld hab variable to account for any starting planets
        owner = {
            every_owned_fleet = {
                limit = {
                    is_frameworld_outpost = yes
                    is_disabled = no
                }
                orbit = {
                    set_variable = { which = fwt_frameworld_planet_base_hab value = modifier:pop_environment_tolerance }
                    prev.owner = { change_variable = { which = fwt_frameworld_hab value = prev.value:fwt_frameworld_hab_percent } }
                }
            }
        }
        while = {
            limit = { owner = { check_variable = { which = outpost_extra value > 0 } } }
            change_planet_size = 1
            create_pop_group = { species = owner_main_species }
            create_pop_group = { species = owner_main_species }
            create_pop_group = { species = owner_main_species }
            if = {
                limit = { owner = { is_catalytic_empire = no } }
                add_district = district_giga_frameworld_urban_04
            }
            else_if = {
                limit = { owner = { is_catalytic_empire = yes } }
                add_district = district_giga_frameworld_urban_04
            }
            owner = { change_variable = { which = outpost_extra value = -1 } }
        }
    }
}

country_event = {
    id = fwt.12
    title = "fwt.12.auto.name"
    desc = "fwt.12.auto.desc"
    is_triggered_only = yes

    trigger = { giga_has_frameworld_origin = yes }

    option = {
        name = fwt.12.continuous_expansion
        trigger = {
            not = { country_has_situation = { SITUATION = fwt_situation_continuous_expansion } }
        }
        start_situation = {
            type = fwt_situation_continuous_expansion
        }
    }

    option = {
        name = fwt.12.continuous_harvest
        start_situation = {
            type = fwt_situation_frameworld_continuous_harvest
        }
    }
}

country_event = {
    id = fwt.121
    title = "fwt.121.growth.name"
    desc = "fwt.121.growth.desc"
    hide_window = no
    is_triggered_only = yes
    picture = GFX_evt_overgrown_city

    trigger = { has_country_flag = giga_host }
    option = {
        name = fwt.12.increase_1
        country_event = { id = fwt.121 }
        change_variable = {
            which = fwt_growth_ceiling
            value = 0.1
        }
    }
    option = {
        name = fwt.12.increase_05
        country_event = { id = fwt.121 }
        change_variable = {
            which = fwt_growth_ceiling
            value = 0.05
        }
    }
    option = {
        name = fwt.12.increase_01
        country_event = { id = fwt.121 }
        change_variable = {
            which = fwt_growth_ceiling
            value = 0.01
        }
    }
    option = {
        name = fwt.12.current_growth_ceiling
        allow = {
            always = no
        }
    }
    option = {
        name = fwt.12.decrease_01
        country_event = { id = fwt.121 }
        change_variable = {
            which = fwt_growth_ceiling
            value = -0.01
        }
    }
    option = {
        name = fwt.12.decrease_05
        country_event = { id = fwt.121 }
        change_variable = {
            which = fwt_growth_ceiling
            value = -0.05
        }
    }
    option = {
        name = fwt.12.decrease_1
        country_event = { id = fwt.121 }
        change_variable = {
            which = fwt_growth_ceiling
            value = -0.1
        }
    }
    option = {
        name = fwt.close_menu
        event_target:giga_global_situation_country = {
            #is the scope the situation is created in
            set_variable = {
                which = fwt_growth_ceiling
                value = root.fwt_growth_ceiling
            }
            every_country = {
                limit = { giga_has_frameworld_origin = yes }
                set_variable = {
                    which = fwt_growth_ceiling
                    value = root.fwt_growth_ceiling
                }
                event_target:frame_expand@this = {
                    set_variable = {
                        which = fwt_growth_ceiling
                        value = root.fwt_growth_ceiling
                    }
                }
            }
        }
        country_event = { id = fwt.122 }
    }
}

country_event = {
    id = fwt.122
    title = "fwt.122.growth.name"
    desc = "fwt.122.growth.desc"
    hide_window = no
    is_triggered_only = yes
    picture = GFX_evt_overgrown_city

    option = {
        name = fwt.12.increase_1
        country_event = { id = fwt.122 }
        change_variable = {
            which = fwt_required_scaling
            value = 0.1
        }
    }
    option = {
        name = fwt.12.increase_05
        country_event = { id = fwt.122 }
        change_variable = {
            which = fwt_required_scaling
            value = 0.05
        }
    }
    option = {
        name = fwt.12.increase_01
        change_variable = {
            which = fwt_required_scaling
            value = 0.01
        }
        country_event = { id = fwt.122 }
    }
    option = {
        name = fwt.12.current_required_scaling
        allow = { always = no }
    }
    option = {
        name = fwt.12.decrease_01
        country_event = { id = fwt.122 }
        change_variable = {
            which = fwt_required_scaling
            value = -0.01
        }
    }
    option = {
        name = fwt.12.decrease_05
        country_event = { id = fwt.122 }
        change_variable = {
            which = fwt_required_scaling
            value = -0.5
        }
    }
    option = {
        name = fwt.12.decrease_1
        country_event = { id = fwt.122 }
        change_variable = {
            which = fwt_required_scaling
            value = -0.1
        }
    }
    option = {
        name = fwt.close_menu
        event_target:giga_global_situation_country = {
            set_variable = {
                which = fwt_required_scaling
                value = root.fwt_required_scaling
            }
            every_country = {
                limit = { giga_has_frameworld_origin = yes }
                set_variable = {
                    which = fwt_required_scaling
                    value = root.fwt_required_scaling
                }
                event_target:frame_expand@this = {
                    set_variable = {
                        which = fwt_growth_ceiling
                        value = root.fwt_required_scaling
                    }
                }
            }
        }
        # every_country = {
        #     limit = { giga_has_frameworld_origin = yes }
        #     event_target:frame_expand@this = { giga_extra_growth_setup = yes }
        # }
    }
}

situation_event = {
    id = fwt.2
    hide_window = yes
    is_triggered_only = yes
    immediate = {
        if = {
            limit = { situation_progress > value:fwt_situation_end_less_than_month }
            set_variable = {
                which = fwt_days_left_timer
                value = value:fwt_situation_end_days_left
            }
            # % of time left * 30
            # progression left / monthly progression
            situation_event = {
                id = fwt.22
                days = 1
            }
        }

        #income
        owner = {
            export_trigger_value_to_variable = {
                trigger = resource_income_compare
                parameters = {
                    resource = alloys
                    value = 0
                }
                variable = fwt_situation_continuous_total_revenue_sub
            }
            change_variable = {
                which = fwt_situation_continuous_total_revenue_sub
                value = modifier:country_situations_expansion_alloys_upkeep_add_offset
            }
        }
        #% of total income to use on situation
        set_variable = {
            which = fwt_situation_continuous_total_revenue_sub
            value = owner.fwt_situation_continuous_total_revenue_sub
        }
        multiply_variable = {
            which = fwt_situation_continuous_total_revenue_sub
            value = value:fwt_situation_continuous_pol_speed
        }
        set_variable = {
            which = fwt_situation_continuous_total_revenue
            value = fwt_situation_continuous_total_revenue_sub
        }
    }
}

situation_event = {
    id = fwt.22
    hide_window = yes
    is_triggered_only = yes
    immediate = {
        # run until the day the the decision time would finish
        if = {
            limit = {
                check_variable = {
                    which = fwt_days_left_timer
                    value < 1
                }
            }
            switch = {
                trigger = is_situation_type
                giga_situation_frameworld_decisions = { fwt_trigger_effects_situation = yes }
                fwt_situation_continuous_expansion = {
                    custom_tooltip = frameworld_line
                    while = {
                        count = value:fwt_situation_finish_count
                        event_target:frame_expand@owner = {
                            remove_planet_flag = giga_frameworld_expand_queued
                            giga_frameworld_expand_deposit = {
                                DEPOSIT = d_frameworld_expansion
                                VAR = giga_frameworld_expansions
                            }
                            custom_tooltip = frameworld_line
                            giga_frameworld_expand_deposit = {
                                DEPOSIT = d_frameworld_structure_expansion
                                VAR = giga_frameworld_structure_expansions
                            }
                            custom_tooltip = frameworld_line
                            change_planet_size = 1

                            # update entity and do all the math
                            hidden_effect = {
                                giga_frameworld_update_entity_with_fallback = yes
                                giga_frameworld_recalculate_variables = yes
                                frameworld_conduct_audit_check_ai = yes
                            }
                            remove_flags = { NAME = giga_frameworld_expand }
                        }
                    }
                    owner = {
                        set_variable = {
                            which = fwt_expansion_extra
                            value = prev.value:fwt_situation_finish_count_sub
                        }
                    }
                    #might fix any jank with more than end of situation
                    owner = {
                        start_situation = { type = fwt_situation_continuous_expansion }
                    }
                    destroy_situation = this
                }
            }
        }
        else = {
            change_variable = {
                which = fwt_days_left_timer
                value = -1
            }
            situation_event = {
                id = fwt.22
                days = 1
            }
        }
    }
}

country_event = {
    id = fwt.3
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        or = {
            last_increased_tech = tech_habitat_1
            last_increased_tech = tech_habitat_2
        }
        giga_has_frameworld_origin = yes
    }

    immediate = {
        #while this is faster than normal if a frameworld isn't taking the voidborne their losing out anyway so it isn't a issue
        if = {
            limit = { last_increased_tech = tech_habitat_1 }
            add_research_option = tech_habitat_2
        }
        #when researching the hab 2 tech give tech option for the hab 3 tech, as can't roll habs with no habs and overwriting tech files required overwriting all
        else = {
            add_research_option = tech_habitat_3
        }
    }
}

country_event = {
    id = fwt.4
    title = "fwt.4.name"
    desc = "fwt.4.desc"
    picture = GFX_evt_overgrown_city
    location = from
    show_sound = event_wind_ruins
    hide_window = no
    is_triggered_only = yes

    option = {
        allow = { not = { any_situation = { is_situation_type = fwt_situation_frameworld_continuous_harvest } } }
        name = fwt.4.asteroid
        start_situation = { type = fwt_situation_frameworld_continuous_harvest }
        country_event = { id = fwt.4 }
    }
    # option = {
    # 	name = fwt.4.maintenance
    # 	country_event = {
    # 		id = fwt.43
    # 	}
    # 	country_event = {
    # 		id = fwt.4
    # 	}
    # }
    option = {
        allow = { not = { any_situation = { is_situation_type = fwt_situation_continuous_expansion } } }
        name = fwt.4.auto_expand
        start_situation = { type = fwt_situation_continuous_expansion }
        country_event = { id = fwt.4 }
    }
    option = {
        name = fwt.close_menu
        remove_country_flag = auto_menu_open
    }
}


country_event = {
    id = fwt.41
    title = "fwt.41.asteroid.name"
    desc = "fwt.41.asteroid.desc"
    picture = GFX_evt_overgrown_city
    location = from
    show_sound = event_wind_ruins
    hide_window = no
    is_triggered_only = yes

    option = {
        name = fwt.41.enable
        allow = { not = { has_country_flag = fwt_asteroid_harvesting } }
        set_country_flag = fwt_asteroid_harvesting
        remove_country_flag = fwt_asteroid_harvesting_1
        country_event = { id = fwt.41 }
    }
    option = {
        name = fwt.41.enable_1
        allow = { not = { has_country_flag = fwt_asteroid_harvesting_1 } }
        set_country_flag = fwt_asteroid_harvesting_1
        remove_country_flag = fwt_asteroid_harvesting
        country_event = { id = fwt.41 }
    }
    option = {
        name = fwt.41.disable
        allow = {
            or = {
                has_country_flag = fwt_asteroid_harvesting
                has_country_flag = fwt_asteroid_harvesting_1
            }
        }
        remove_country_flag = fwt_asteroid_harvesting
        remove_country_flag = fwt_asteroid_harvesting_1
        country_event = { id = fwt.41 }
    }
    option = {
        name = fwt.close_menu
        country_event = { id = fwt.412 }
    }
}

ship_event = {
    id = fwt.4111
    hide_window = yes
    is_triggered_only = yes

    immediate = {
        if = {
            limit = {
                exists = from
                from = { is_scope_type = country }
            }
            from = { country_event = { id = fwt.412 } }
        }
        else = { owner = { country_event = { id = fwt.412 } } }
    }
}

system_event = {
    id = fwt.4112
    hide_window = yes
    is_triggered_only = yes

    immediate = {
        owner = { country_event = { id = fwt.412 } }
    }
}

# This = ship (starbase)
# From = owner country
# on_building_starbase_outpost
system_event = {
    id = fwt.4113
    hide_window = yes
    is_triggered_only = yes

    immediate = {
        this = { solar_system = { system_event = { id = fwt.413 } } }
    }
}


country_event = {
    id = fwt.412
    hide_window = yes
    is_triggered_only = yes

    immediate = {
        remove_country_flag = has_more_asteroids
        remove_country_flag = has_more_asteroids_1
        if = {
            limit = {
                has_country_flag = fwt_asteroid_harvesting_1
                any_planet_within_border = {
                    is_asteroid = yes
                    solar_system = {
                        count_system_planet = {
                            count > 1
                            limit = {
                                is_asteroid = yes
                            }
                        }
                    }
                    system_has_arc_furnace = no
                }
            }
            set_country_flag = has_more_asteroids_1
        }
        else_if = {
            limit = {
                has_country_flag = fwt_asteroid_harvesting
                any_planet_within_border = {
                    is_asteroid = yes
                    system_has_arc_furnace = no
                }
            }
            set_country_flag = has_more_asteroids
        }
    }
}

system_event = {
    id = fwt.413
    hide_window = yes
    is_triggered_only = yes

    immediate = {
        if = {
            limit = {
                owner = {
                    nor = {
                        has_country_flag = has_more_asteroids
                        has_country_flag = has_more_asteroids_1
                    }
                }
            }
            if = {
                limit = {
                    owner = {
                        has_country_flag = fwt_asteroid_harvesting_1
                    }
                    any_system_planet = {
                        is_asteroid = yes
                        solar_system = {
                            count_system_planet = {
                                count > 1
                                limit = {
                                    is_asteroid = yes
                                }
                            }
                        }
                        system_has_arc_furnace = no
                    }
                }
                owner = {
                    set_country_flag = has_more_asteroids_1
                }
            }
            else_if = {
                limit = {
                    owner = {
                        has_country_flag = fwt_asteroid_harvesting
                    }
                    any_system_planet = {
                        is_asteroid = yes
                        system_has_arc_furnace = no
                    }
                }
                owner = {
                    set_country_flag = has_more_asteroids
                }
            }
        }
    }
}

situation_event = {
    id = fwt.42
    title = "fwt.42.expand.name"
    desc = "fwt.42.expand.desc"
    picture = GFX_evt_overgrown_city
    location = from
    show_sound = event_wind_ruins
    hide_window = no
    is_triggered_only = yes

    option = {
        name = fwt.4.increase_10
        situation_event = { id = fwt.42 }
        owner = {
            change_variable = {
                which = fwt_expansion_income
                value = 10
            }
        }
        change_variable = {
            which = fwt_expansion_income
            value = 10
        }
    }
    option = {
        name = fwt.4.increase_5
        situation_event = { id = fwt.42 }
        owner = {
            change_variable = {
                which = fwt_expansion_income
                value = 5
            }
        }
        change_variable = {
            which = fwt_expansion_income
            value = 5
        }
    }
    option = {
        name = fwt.4.increase_1
        change_variable = {
            which = fwt_expansion_income
            value = 1
        }
        owner = {
            change_variable = {
                which = fwt_expansion_income
                value = 1
            }
        }
        situation_event = { id = fwt.42 }
    }
    option = {
        name = fwt.4.current
        allow = {
            always = no
        }
    }
    option = {
        name = fwt.4.decrease_1
        change_variable = {
            which = fwt_expansion_income
            value = -1
        }
        owner = {
            change_variable = {
                which = fwt_expansion_income
                value = -1
            }
        }
        situation_event = { id = fwt.42 }
    }
    option = {
        name = fwt.4.decrease_5
        change_variable = {
            which = fwt_expansion_income
            value = -5
        }
        owner = {
            change_variable = {
                which = fwt_expansion_income
                value = -5
            }
        }
        situation_event = { id = fwt.42 }
    }
    option = {
        name = fwt.4.decrease_10
        change_variable = {
            which = fwt_expansion_income
            value = -10
        }
        owner = {
            change_variable = {
                which = fwt_expansion_income
                value = -10
            }
        }
        situation_event = { id = fwt.42 }
    }
    option = {
        name = fwt.close_menu
        set_situation_approach = fwt_situation_continuous_expansion_approach_speed
        if = {
            limit = { owner = { has_country_flag = auto_menu_open } }
            owner = { remove_country_flag = auto_menu_open }
        }
    }
}


country_event = {
    id = fwt.5
    hide_window = yes
    is_triggered_only = yes

    trigger = { giga_has_frameworld_origin = yes }
    immediate = {
        event_target:frame_expand@owner = {
            planet_event = {
            id = fwt.51
                days = 1
            }
        }
    }
}


planet_event = {
    id = fwt.51
    hide_window = yes
    is_triggered_only = yes

    immediate = {
        # 100
        set_variable = {
            which = fwt_pop_growth_rec
            value = trigger:pop_amount
        }
        multiply_variable = {
            which = fwt_pop_growth_rec
            value = owner.fwt_required_scaling
        }
        change_variable = {
            which = fwt_pop_growth_rec
            value = 100
        }

        set_variable = {
            which = fwt_pop_growth_rec_back
            value = background_pops
        }
        change_variable = {
            which = fwt_pop_growth_rec_back
            value = trigger:pop_amount
        }
        multiply_variable = {
            which = fwt_pop_growth_rec_back
            value = owner.fwt_required_scaling
        }
        change_variable = {
            which = fwt_pop_growth_rec_back
            value = 100
        }

        divide_variable = {
            which = fwt_pop_growth_rec
            value = fwt_pop_growth_rec_back
        }

        subtract_variable = {
            which = fwt_pop_growth_rec
            value = 1
        }
        multiply_variable = {
            which = fwt_pop_growth_rec
            value = -1
        }

        set_variable = {
            which = fwt_pop_growth_reduction
            value = modifier:logistic_growth_mult
        }
        change_variable = {
            which = fwt_pop_growth_reduction
            value = -1
        }
        multiply_variable = {
            which = fwt_pop_growth_rec
            value = -1
        }
        multiply_variable = {
            which = fwt_pop_growth_reduction
            value = fwt_pop_growth_rec
        }
    }
}

#yearly_pulse_country
country_event = {
    id = fwt.6
    hide_window = yes
    is_triggered_only = yes

    immediate = {
        set_variable = { which = fwt_frameworld_hab value = 0 }
        every_owned_fleet = {
            limit = {
                is_frameworld_outpost = yes
                is_disabled = no
            }
            orbit = {
                prev.owner = { change_variable = { which = fwt_frameworld_hab value = prev.value:fwt_frameworld_hab_percent } }
            }
        }
    }
}

situation_event = {
    id = fwt.999
    hide_window = yes
    is_triggered_only = yes
    immediate = {
        #cwtools scripted effect aren't check properly so set flags to make it think it is set even those this is never triggered
        set_situation_flag = giga_frameworld_expand_dec
        set_situation_flag = giga_frameworld_expand_bulk_5_dec
        set_situation_flag = giga_frameworld_expand_bulk_10_dec
        set_situation_flag = giga_frameworld_expand_mass_dec
        set_situation_flag = giga_frameworld_expand_mass_bulk_5_dec
        set_situation_flag = giga_frameworld_reorganise_dec
        set_situation_flag = giga_frameworld_consume_world_dec
    }
}